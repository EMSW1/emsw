<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMSW | DASHBOARD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        .glass-card { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0,0,0,0.05); }
        .dark .glass-card { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(12px); }
        .global-stat-card { border-radius: 24px; padding: 20px; text-align: center; border-bottom: 4px solid #3b82f6; }
        .entity-label { transition: all 0.2s ease; cursor: pointer; }
        .entity-label:hover { transform: translateX(10px); color: #3b82f6; }
        .details-panel { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .details-panel.open { max-height: 2000px; transition: max-height 1s ease-in; }
        .stat-input { background: rgba(0,0,0,0.05); border: 1px solid transparent; text-align: center; font-weight: 800; border-radius: 6px; width: 100%; font-size: 14px; padding: 4px; }
        .dark .stat-input { background: rgba(255,255,255,0.05); color: white; }
        .label-xs { font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; }

        #loginOverlay { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: #0b1120; }
        .viewer-mode .save-btn { display: none !important; }
        .viewer-mode .stat-input { pointer-events: none; opacity: 0.8; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-[#0b1120] text-slate-900 dark:text-slate-100 p-4 md:p-8">

    <div id="loginOverlay">
        <div class="glass-card p-10 rounded-[2.5rem] w-full max-w-sm shadow-2xl text-center border border-white/10">
            <h2 class="text-3xl font-[900] italic mb-6 uppercase">EMS <span class="text-blue-500">AUTH</span></h2>
            <input type="password" id="accessKey" onkeypress="if(event.key==='Enter') checkRole()" placeholder="ENTER KEY" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-2xl text-center mb-4 text-white font-black outline-none focus:border-blue-500 transition-all">
            <button onclick="checkRole()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase text-sm tracking-widest transition-all">Login</button>
        </div>
    </div>

    <div id="dashboardContent" class="hidden">
        <header class="max-w-6xl mx-auto mb-10 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-[900] italic tracking-tighter uppercase">EMSW <span class="text-blue-500">DASHBOARD</span></h1>
                <p id="role-display" class="text-[10px] font-black text-slate-500 uppercase tracking-widest italic">Global Viewer</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleDarkMode()" class="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm border dark:border-slate-700">
                    <span class="dark:hidden">‚òÄÔ∏è</span><span class="hidden dark:inline">üåô</span>
                </button>
                <button onclick="logout()" class="bg-red-500/10 text-red-500 border border-red-500/20 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-red-600 hover:text-white transition-all">Logout</button>
            </div>
        </header>

        <section class="max-w-6xl mx-auto mb-12">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-4 ml-2">Global Stats (Live)</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="glass-card global-stat-card"><p class="label-xs">Total RDPs</p><h3 id="global-rdps" class="text-3xl font-black italic">0</h3></div>
                <div class="glass-card global-stat-card border-emerald-500"><p class="label-xs">Total Seeds</p><h3 id="global-seeds" class="text-3xl font-black italic text-emerald-500">0</h3></div>
                <div class="glass-card global-stat-card border-purple-500"><p class="label-xs">Qualit√© en cours</p><h3 id="global-qualite" class="text-3xl font-black italic text-purple-500">0</h3></div>
                <div class="glass-card global-stat-card border-orange-500"><p class="label-xs">Paused en cours</p><h3 id="global-paused" class="text-3xl font-black italic text-orange-500">0</h3></div>
                <div class="glass-card global-stat-card border-slate-400"><p class="label-xs">Total Deploys</p><h3 id="global-proxy" class="text-3xl font-black italic">0</h3></div>
            </div>
        </section>

        <section class="max-w-6xl mx-auto space-y-4">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-4 ml-2">D√©tails Entit√©s</h2>
            
            <div class="glass-card rounded-[2rem] overflow-hidden">
                <div onclick="togglePanel('ems4-panel')" class="entity-label p-6 flex justify-between items-center group">
                    <div class="flex items-center gap-4">
                        <span class="bg-blue-600 text-white font-black px-4 py-1 rounded-full italic text-sm">EMS4</span>
                        <span class="text-sm font-black uppercase tracking-widest text-slate-400 group-hover:text-blue-500">REAL-TIME MONITOR</span>
                    </div>
                    <svg class="w-5 h-5 text-slate-400 transform transition-transform" id="ems4-panel-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="3"></path></svg>
                </div>

                <div id="ems4-panel" class="details-panel bg-slate-50/50 dark:bg-black/20 px-8 pb-8">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 pt-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b border-blue-500/20 pb-1">
                                <p class="text-blue-500 font-black italic uppercase text-xs">Platform Web</p>
                                <p class="text-[10px] font-black uppercase text-slate-400">Total Seeds: <span id="web-total-seeds" class="text-blue-500 font-black">0</span></p>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><p class="label-xs">RDPs</p><input type="text" data-path="ems4/plans/WEB/current/stats/rdps" class="stat-input" disabled></div>
                                <div><p class="label-xs">Sessions</p><input type="text" data-path="ems4/plans/WEB/current/stats/sessions" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Deploys/h</p><input type="text" id="web-deploys-count" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Deploys/d</p><input type="text" data-path="ems4/plans/WEB/current/stats/nbrseploysperday" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Seeds/h</p><input type="text" data-path="ems4/plans/WEB/current/stats/nbrseedsperhour" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Seeds/d</p><input type="text" data-path="ems4/plans/WEB/current/stats/nbrseedsperday" class="stat-input" disabled></div>
                                <div><p class="label-xs">Lancements</p><input type="text" data-path="ems4/plans/WEB/current/stats/nbrlancement" class="stat-input" disabled></div>
                                <div><p class="label-xs">Rotation</p><input type="text" data-path="ems4/plans/WEB/current/stats/rotMin" class="stat-input" disabled></div>
                                <div><p class="label-xs">Qualit√©</p><input type="text" data-path="ems4/plans/WEB/current/stats/quality" class="stat-input text-emerald-500" disabled></div>
                                <div><p class="label-xs">Paused</p><input type="text" data-path="ems4/plans/WEB/current/stats/paused" class="stat-input text-rose-500" disabled></div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b border-purple-500/20 pb-1">
                                <p class="text-purple-500 font-black italic uppercase text-xs">Platform Selenium</p>
                                <p class="text-[10px] font-black uppercase text-slate-400">Total Seeds: <span id="selenium-total-seeds" class="text-purple-500 font-black">0</span></p>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><p class="label-xs">RDPs</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/rdps" class="stat-input" disabled></div>
                                <div><p class="label-xs">Sessions</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/sessions" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Deploys/h</p><input type="text" id="selenium-deploys-count" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Deploys/d</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/nbrseploysperday" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Seeds/h</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/nbrseedsperhour" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Seeds/d</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/nbrseedsperday" class="stat-input" disabled></div>
                                <div><p class="label-xs">Lancements</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/nbrlancement" class="stat-input" disabled></div>
                                <div><p class="label-xs">Rotation</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/rotMin" class="stat-input" disabled></div>
                                <div><p class="label-xs">Qualit√©</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/quality" class="stat-input text-emerald-500" disabled></div>
                                <div><p class="label-xs">Paused</p><input type="text" data-path="ems4/plans/SELENIUM/current/stats/paused" class="stat-input text-rose-500" disabled></div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b border-emerald-500/20 pb-1">
                                <p class="text-emerald-500 font-black italic uppercase text-xs">Platform Automat</p>
                                <p class="text-[10px] font-black uppercase text-slate-400">Total Seeds: <span id="automat-total-seeds" class="text-emerald-500 font-black">0</span></p>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><p class="label-xs">RDPs</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/rdps" class="stat-input" disabled></div>
                                <div><p class="label-xs">Sessions</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/sessions" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Deploys/h</p><input type="text" id="automat-deploys-count" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Deploys/d</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/nbrseploysperday" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Seeds/h</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/nbrseedsperhour" class="stat-input" disabled></div>
                                <div><p class="label-xs">Nbr-Seeds/d</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/nbrseedsperday" class="stat-input" disabled></div>
                                <div><p class="label-xs">Lancements</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/nbrlancement" class="stat-input" disabled></div>
                                <div><p class="label-xs">Rotation</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/rotMin" class="stat-input" disabled></div>
                                <div><p class="label-xs">Qualit√©</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/quality" class="stat-input text-emerald-500" disabled></div>
                                <div><p class="label-xs">Paused</p><input type="text" data-path="ems4/plans/AUTOMAT/current/stats/paused" class="stat-input text-rose-500" disabled></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAFR96bibEGLaMroqFZCLcSHyCoAdewz78",
            authDomain: "ems4-reporting.firebaseapp.com",
            databaseURL: "https://ems4-reporting-default-rtdb.firebaseio.com",
            projectId: "ems4-reporting"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const KEYS = { super: "1992", admin: "emsw@2026.." };
        function checkRole() {
            const k = document.getElementById('accessKey').value;
            if (k === KEYS.super) loginSuccess("super");
            else if (k === KEYS.admin) loginSuccess("admin");
            else alert("Wrong Key ‚ùå");
        }
        function loginSuccess(role) {
            localStorage.setItem('ems_role', role);
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('dashboardContent').classList.remove('hidden');
            document.getElementById('role-display').innerText = (role === 'super') ? "SUPER ADMIN ACCESS" : "ADMIN VIEWER ACCESS";
            document.body.classList.toggle('viewer-mode', role !== 'super');
        }
        function logout() { localStorage.removeItem('ems_role'); location.reload(); }
        if (localStorage.getItem('ems_role')) loginSuccess(localStorage.getItem('ems_role'));

        function togglePanel(id) {
            const panel = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            panel.classList.toggle('open');
            icon.style.transform = panel.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        // LIVE SYNCHRONIZATION
        db.ref('ems4/plans').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // Simple mapping
            document.querySelectorAll('[data-path]').forEach(inp => {
                const path = inp.getAttribute('data-path').replace('ems4/plans/', '').split('/');
                let val = data;
                path.forEach(p => val = val ? val[p] : '');
                inp.value = val || '-';
            });

            const platforms = ['WEB', 'SELENIUM', 'AUTOMAT'];
            let gRdp = 0, gSeeds = 0, gQual = 0, gPau = 0, gDep = 0;

            platforms.forEach(p => {
                const current = data[p]?.current || {};
                const stats = current.stats || {};
                const deployCount = (current.deploys) ? current.deploys.length : 0;
                
                // 1. Update Nbr-Deploys/h (Based on list length)
                const depInp = document.getElementById(`${p.toLowerCase()}-deploys-count`);
                if(depInp) depInp.value = deployCount;

                // 2. Update Total Seeds for each platform
                const seedLabel = document.getElementById(`${p.toLowerCase()}-total-seeds`);
                if(seedLabel) seedLabel.innerText = stats.seeds || 0;

                // Global totals
                gRdp += parseInt(stats.rdps) || 0;
                gSeeds += parseInt(stats.seeds) || 0;
                gQual += parseInt(stats.quality) || 0;
                gPau += parseInt(stats.paused) || 0;
                gDep += deployCount;
            });

            document.getElementById('global-rdps').innerText = gRdp;
            document.getElementById('global-seeds').innerText = gSeeds;
            document.getElementById('global-qualite').innerText = gQual;
            document.getElementById('global-paused').innerText = gPau;
            document.getElementById('global-proxy').innerText = gDep;
        });
    </script>
</body>
</html>
